---
tags:
 - DB
 - NoSQL
 - 分散処理
---

# 目次
    - なぜRDBではなくNoSQLなのか？
    - NoSQLとは？
    - NoSQLのアンチパターン
    - NoSQLのユースケース


# なぜRDBではなくNoSQLなのか？
・処理能力を向上させるためにハードウェアの補強（スケールアップ）を行うには限界がある
・サーバーを増やす（スケールアウト）には高コスト
・データの量増加、非構造化データの登場

# NoSQLとは？
・Not only sql(sqlに限定されない)
・RDBSに存在したスキームによる一貫性を削っている(型厳密でない)
=>結果整合性という考え方で、時間が経ったら一貫性が保証されるような設計に基づく
・非構造化データを扱うため、構造化データの関係性を必要とするような参照には向かない
・一部トランザクション実装しているものもある
・参照や追加は高速
・更新や削除には向かない
・ある意味トランザクションだったりデッドロックの回避だったりを意識する必要がなく手軽

# NoSQLのアンチパターン
NoSQLのCASを利用して整合性を保つ！
CASは1つのドキュメントの整合性を守るための仕組み
・2つのプロセスについて、両方が同一データを取得しており、共に別のデータに書き換える事を考える。(以下の様になる)

(1) プロセスA更新
(2) データがAに合わせて更新される
(3) プロセスB更新
(4) データが元々の状態から変化してしまっているためエラー
(5) プロセスBにエラー通知
(6) プロセスBはデータを再取得して再度更新処理

=>確かに整合性は守れるが、以下のデメリット
・ドキュメント1つ1つが肥大化(メモリ的制約)
・速さが売りなのに場合によっては処理が終わらない...
(mongoDBは整合性を保つためトランザクションを実装したがこれにより速度は減少...元も子もない)

上記を受けて、
書き込みを単一プロセスにしようと思ったら、更新途中のレコードが見えてしまったり別の問題が発生(結局ロックを実装したり実装難易度が上がって意味がない...)


# NoSQLのユースケース
・メインDBはRDBにして、水平分割を利用
-　NoSQL系のredisやdynamoにキーとdb_hostのマップを置いておく！
(正しこれは単一障害点になる=これが壊れるとシステムが完全に止まるため、一方向的な演算関数を作ってdb_hostを算出するような仕組みが有れば最高)

調査:
    ロックの話
    https://logmi.jp/tech/articles/321472